<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Building Configuration - Campus Navigation Admin</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #333;
            font-size: 28px;
        }

        .nav-links {
            display: flex;
            gap: 15px;
        }

        .nav-links a {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            transition: background 0.3s;
        }

        .nav-links a:hover {
            background: #764ba2;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
        }

        .sidebar {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            height: fit-content;
        }

        .content-area {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .building-selector {
            margin-bottom: 25px;
        }

        .building-selector select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h3 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #667eea;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group textarea {
            height: 80px;
            resize: vertical;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            margin-right: 5px;
            transition: all 0.3s;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .floor-plan-canvas {
            border: 2px solid #ddd;
            border-radius: 8px;
            background: #f8f9fa;
            width: 100%;
            height: 400px;
        }

        .room-list, .connection-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }

        .room-item, .connection-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        .room-item:last-child, .connection-item:last-child {
            border-bottom: none;
        }

        .room-info {
            flex: 1;
        }

        .room-name {
            font-weight: 600;
            color: #333;
        }

        .room-details {
            font-size: 12px;
            color: #666;
        }

        .room-actions {
            display: flex;
            gap: 5px;
        }

        .alert {
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .coordinate-input {
            display: flex;
            gap: 10px;
        }

        .coordinate-input input {
            flex: 1;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #000;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-building"></i> Building Configuration</h1>
            <div class="nav-links">
                <a href="/admin"><i class="fas fa-tachometer-alt"></i> Campus Config</a>
                <a href="/admin/debug"><i class="fas fa-bug"></i> Debug</a>
                <a href="/"><i class="fas fa-map"></i> Main App</a>
                <button onclick="logout()" class="btn btn-secondary">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>

        <div id="alerts"></div>

        <div class="main-content">
            <div class="sidebar">
                <div class="building-selector">
                    <label for="buildingSelect"><strong>Select Building:</strong></label>
                    <select id="buildingSelect" onchange="loadBuildingConfig()">
                        <option value="">Choose a building...</option>
                    </select>
                </div>

                <div class="section">
                    <h3>Quick Actions</h3>
                    <button onclick="saveBuildingConfig()" class="btn btn-success">
                        <i class="fas fa-save"></i> Save Configuration
                    </button>
                    <button onclick="resetBuildingConfig()" class="btn btn-secondary">
                        <i class="fas fa-undo"></i> Reset Changes
                    </button>
                </div>

                <div class="section">
                    <h3>Building Info</h3>
                    <div id="buildingInfo" class="loading">
                        Select a building to view configuration
                    </div>
                </div>
            </div>

            <div class="content-area">
                <div class="tabs">
                    <button class="tab active" onclick="showTab('floors')">
                        <i class="fas fa-layer-group"></i> Floors & Rooms
                    </button>
                    <button class="tab" onclick="showTab('connections')">
                        <i class="fas fa-project-diagram"></i> Connections
                    </button>
                    <button class="tab" onclick="showTab('vertical')">
                        <i class="fas fa-stairs"></i> Stairs & Elevators
                    </button>
                    <button class="tab" onclick="showTab('visual')">
                        <i class="fas fa-eye"></i> Floor Plan
                    </button>
                </div>

                <div id="floors-tab" class="tab-content active">
                    <div class="section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3>Floors Management</h3>
                            <button onclick="showAddFloorModal()" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Add Floor
                            </button>
                        </div>
                        
                        <div class="form-group">
                            <label for="floorSelect">Current Floor:</label>
                            <select id="floorSelect" onchange="loadFloorRooms()">
                                <option value="">Select a floor...</option>
                            </select>
                        </div>

                        <div id="roomsSection" style="display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4>Rooms on Floor</h4>
                                <button onclick="showAddRoomModal()" class="btn btn-primary">
                                    <i class="fas fa-plus"></i> Add Room
                                </button>
                            </div>
                            <div id="roomsList" class="room-list">
                                <!-- Rooms will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <div id="connections-tab" class="tab-content">
                    <div class="section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3>Floor Connections</h3>
                            <button onclick="showAddConnectionModal()" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Add Connection
                            </button>
                        </div>
                        <div id="connectionsList" class="connection-list">
                            <!-- Connections will be loaded here -->
                        </div>
                    </div>
                </div>

                <div id="vertical-tab" class="tab-content">
                    <div class="section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3>Stairs</h3>
                            <button onclick="showAddStairsModal()" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Add Stairs
                            </button>
                        </div>
                        <div id="stairsList">
                            <!-- Stairs will be loaded here -->
                        </div>
                    </div>

                    <div class="section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3>Elevators</h3>
                            <button onclick="showAddElevatorModal()" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Add Elevator
                            </button>
                        </div>
                        <div id="elevatorsList">
                            <!-- Elevators will be loaded here -->
                        </div>
                    </div>
                </div>

                <div id="visual-tab" class="tab-content">
                    <div class="section">
                        <h3>Floor Plan Visualization</h3>
                        <div class="form-group">
                            <label for="visualFloorSelect">Select Floor:</label>
                            <select id="visualFloorSelect" onchange="drawFloorPlan()">
                                <option value="">Select a floor to visualize...</option>
                            </select>
                        </div>
                        <canvas id="floorPlanCanvas" class="floor-plan-canvas"></canvas>
                        <div style="margin-top: 10px;">
                            <small><strong>Legend:</strong> 
                                <span style="color: #667eea;">■</span> Rooms
                                <span style="color: #28a745;">■</span> Entrances
                                <span style="color: #dc3545;">■</span> Stairs
                                <span style="color: #ffc107;">■</span> Elevators
                                <span style="color: #6c757d;">—</span> Connections
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="floorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="floorModalTitle">Add Floor</h3>
                <span class="close" onclick="closeModal('floorModal')">&times;</span>
            </div>
            <form id="floorForm" onsubmit="saveFloor(event)">
                <div class="form-group">
                    <label for="floorId">Floor ID:</label>
                    <input type="text" id="floorId" required placeholder="e.g., ground, first, second">
                </div>
                <div class="form-group">
                    <label for="floorName">Floor Name:</label>
                    <input type="text" id="floorName" required placeholder="e.g., Ground Floor">
                </div>
                <div class="form-group">
                    <label for="floorLevel">Floor Level (numeric):</label>
                    <input type="number" id="floorLevel" required placeholder="0 for ground, 1 for first, etc.">
                </div>
                <button type="submit" class="btn btn-success">Save Floor</button>
                <button type="button" onclick="closeModal('floorModal')" class="btn btn-secondary">Cancel</button>
            </form>
        </div>
    </div>

    <div id="roomModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="roomModalTitle">Add Room</h3>
                <span class="close" onclick="closeModal('roomModal')">&times;</span>
            </div>
            <form id="roomForm" onsubmit="saveRoom(event)">
                <div class="form-group">
                    <label for="roomId">Room ID:</label>
                    <input type="text" id="roomId" required placeholder="e.g., room_101">
                </div>
                <div class="form-group">
                    <label for="roomName">Room Name:</label>
                    <input type="text" id="roomName" required placeholder="e.g., Classroom 101">
                </div>
                <div class="form-group">
                    <label for="roomType">Room Type:</label>
                    <select id="roomType" required>
                        <option value="classroom">Classroom</option>
                        <option value="office">Office</option>
                        <option value="lab">Laboratory</option>
                        <option value="entrance">Entrance</option>
                        <option value="restroom">Restroom</option>
                        <option value="common">Common Area</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Coordinates (X, Y):</label>
                    <div class="coordinate-input">
                        <input type="number" id="roomX" required placeholder="X coordinate" step="0.1">
                        <input type="number" id="roomY" required placeholder="Y coordinate" step="0.1">
                    </div>
                </div>
                <div class="form-group">
                    <label for="roomDescription">Description:</label>
                    <textarea id="roomDescription" placeholder="Room description..."></textarea>
                </div>
                <button type="submit" class="btn btn-success">Save Room</button>
                <button type="button" onclick="closeModal('roomModal')" class="btn btn-secondary">Cancel</button>
            </form>
        </div>
    </div>

    <div id="connectionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Connection</h3>
                <span class="close" onclick="closeModal('connectionModal')">&times;</span>
            </div>
            <form id="connectionForm" onsubmit="saveConnection(event)">
                <div class="form-group">
                    <label for="connectionFloor">Floor:</label>
                    <select id="connectionFloor" required onchange="loadRoomOptions()">
                        <option value="">Select floor...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="connectionRoom1">From Room:</label>
                    <select id="connectionRoom1" required>
                        <option value="">Select room...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="connectionRoom2">To Room:</label>
                    <select id="connectionRoom2" required>
                        <option value="">Select room...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="connectionDistance">Distance (meters):</label>
                    <input type="number" id="connectionDistance" step="0.1" placeholder="Distance in meters">
                    <small>Leave empty to auto-calculate from coordinates</small>
                </div>
                <button type="submit" class="btn btn-success">Save Connection</button>
                <button type="button" onclick="closeModal('connectionModal')" class="btn btn-secondary">Cancel</button>
            </form>
        </div>
    </div>

    <script>
        let currentBuilding = null;
        let buildingConfig = null;

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadBuildings();
        });

        async function loadBuildings() {
            try {
                const response = await fetch('/api/buildings');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('buildingSelect');
                    select.innerHTML = '<option value="">Choose a building...</option>';
                    
                    data.buildings.forEach(building => {
                        const option = document.createElement('option');
                        option.value = building.id;
                        option.textContent = building.name;
                        select.appendChild(option);
                    });
                } else {
                    showAlert('Error loading buildings: ' + data.error, 'error');
                }
            } catch (error) {
                showAlert('Error loading buildings: ' + error.message, 'error');
            }
        }

        async function loadBuildingConfig() {
            const buildingId = document.getElementById('buildingSelect').value;
            if (!buildingId) {
                document.getElementById('buildingInfo').innerHTML = 'Select a building to view configuration';
                return;
            }

            currentBuilding = buildingId;
            document.getElementById('buildingInfo').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';

            try {
                const response = await fetch(`/api/buildings/${buildingId}/interior`);
                const data = await response.json();
                
                if (data.success) {
                    buildingConfig = data.interior;
                    displayBuildingInfo();
                    loadFloorSelects();
                    loadFloorRooms();
                } else {
                    showAlert('Error loading building configuration: ' + data.error, 'error');
                }
            } catch (error) {
                showAlert('Error loading building configuration: ' + error.message, 'error');
            }
        }

        function displayBuildingInfo() {
            if (!buildingConfig) return;

            const floorsCount = Object.keys(buildingConfig.floors || {}).length;
            const roomsCount = Object.values(buildingConfig.floors || {})
                .reduce((total, floor) => total + Object.keys(floor.rooms || {}).length, 0);
            const stairsCount = (buildingConfig.vertical_connections?.stairs || []).length;
            const elevatorsCount = (buildingConfig.vertical_connections?.elevators || []).length;

            document.getElementById('buildingInfo').innerHTML = `
                <div><strong>Building:</strong> ${buildingConfig.building_name}</div>
                <div><strong>Floors:</strong> ${floorsCount}</div>
                <div><strong>Total Rooms:</strong> ${roomsCount}</div>
                <div><strong>Stairs:</strong> ${stairsCount}</div>
                <div><strong>Elevators:</strong> ${elevatorsCount}</div>
            `;
        }

        function loadFloorSelects() {
            if (!buildingConfig) return;

            const selects = ['floorSelect', 'visualFloorSelect', 'connectionFloor'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Select a floor...</option>';
                
                Object.entries(buildingConfig.floors || {}).forEach(([floorId, floorData]) => {
                    const option = document.createElement('option');
                    option.value = floorId;
                    option.textContent = floorData.name || floorId;
                    select.appendChild(option);
                });
            });
        }

        function loadFloorRooms() {
            const floorId = document.getElementById('floorSelect').value;
            const roomsSection = document.getElementById('roomsSection');
            
            if (!floorId || !buildingConfig) {
                roomsSection.style.display = 'none';
                return;
            }

            roomsSection.style.display = 'block';
            const roomsList = document.getElementById('roomsList');
            const floor = buildingConfig.floors[floorId];
            
            if (!floor || !floor.rooms) {
                roomsList.innerHTML = '<div>No rooms on this floor</div>';
                return;
            }

            roomsList.innerHTML = '';
            Object.entries(floor.rooms).forEach(([roomId, roomData]) => {
                const roomItem = document.createElement('div');
                roomItem.className = 'room-item';
                roomItem.innerHTML = `
                    <div class="room-info">
                        <div class="room-name">${roomData.name || roomId}</div>
                        <div class="room-details">
                            Type: ${roomData.type || 'common'} | 
                            Coordinates: (${roomData.coordinates ? roomData.coordinates.join(', ') : 'N/A'})
                        </div>
                    </div>
                    <div class="room-actions">
                        <button onclick="editRoom('${floorId}', '${roomId}')" class="btn btn-primary">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteRoom('${floorId}', '${roomId}')" class="btn btn-danger">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                roomsList.appendChild(roomItem);
            });
        }

        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Mark selected tab as active
            event.target.classList.add('active');

            // Load data for specific tabs
            if (tabName === 'connections') {
                loadConnections();
            } else if (tabName === 'vertical') {
                loadVerticalConnections();
            }
        }

        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showAddFloorModal() {
            document.getElementById('floorModalTitle').textContent = 'Add Floor';
            document.getElementById('floorForm').reset();
            showModal('floorModal');
        }

        function showAddRoomModal() {
            const floorId = document.getElementById('floorSelect').value;
            if (!floorId) {
                showAlert('Please select a floor first', 'error');
                return;
            }
            document.getElementById('roomModalTitle').textContent = 'Add Room';
            document.getElementById('roomForm').reset();
            document.getElementById('roomId').disabled = false; // Enable room ID input for new rooms
            showModal('roomModal');
        }

        function showAddConnectionModal() {
            if (!buildingConfig) {
                showAlert('Please select a building first', 'error');
                return;
            }
            document.getElementById('connectionForm').reset();
            loadFloorSelects();
            showModal('connectionModal');
        }

        async function saveFloor(event) {
            event.preventDefault();
            
            const floorId = document.getElementById('floorId').value;
            const floorName = document.getElementById('floorName').value;
            const floorLevel = parseInt(document.getElementById('floorLevel').value);

            if (!buildingConfig.floors) {
                buildingConfig.floors = {};
            }

            buildingConfig.floors[floorId] = {
                name: floorName,
                level: floorLevel,
                rooms: {},
                connections: [],
                entrances: [],
                floor_plan: {
                    width: 100,
                    height: 100,
                    scale_meters_per_unit: 1.0
                }
            };

            closeModal('floorModal');
            loadFloorSelects();
            showAlert('Floor added successfully', 'success');
        }

        async function saveRoom(event) {
            event.preventDefault();
            
            const floorId = document.getElementById('floorSelect').value;
            const roomId = document.getElementById('roomId').value;
            const roomName = document.getElementById('roomName').value;
            const roomType = document.getElementById('roomType').value;
            const roomX = parseFloat(document.getElementById('roomX').value);
            const roomY = parseFloat(document.getElementById('roomY').value);
            const roomDescription = document.getElementById('roomDescription').value;

            if (!buildingConfig.floors[floorId].rooms) {
                buildingConfig.floors[floorId].rooms = {};
            }

            buildingConfig.floors[floorId].rooms[roomId] = {
                name: roomName,
                type: roomType,
                coordinates: [roomX, roomY],
                description: roomDescription
            };

            closeModal('roomModal');
            loadFloorRooms();
            showAlert('Room added successfully', 'success');
        }

        async function saveBuildingConfig() {
            if (!currentBuilding || !buildingConfig) {
                showAlert('No building configuration to save', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/buildings/${currentBuilding}/interior`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(buildingConfig)
                });

                const data = await response.json();
                
                if (data.success) {
                    showAlert('Building configuration saved successfully', 'success');
                } else {
                    showAlert('Error saving configuration: ' + data.error, 'error');
                }
            } catch (error) {
                showAlert('Error saving configuration: ' + error.message, 'error');
            }
        }

        function resetBuildingConfig() {
            if (confirm('Are you sure you want to reset all changes? This will reload the configuration from the server.')) {
                loadBuildingConfig();
            }
        }

        function loadConnections() {
            const connectionsList = document.getElementById('connectionsList');
            if (!buildingConfig || !buildingConfig.floors) {
                connectionsList.innerHTML = '<div>No floors configured</div>';
                return;
            }
            
            connectionsList.innerHTML = '';
            
            // Show connections for each floor
            Object.entries(buildingConfig.floors).forEach(([floorId, floorData]) => {
                if (floorData.connections && floorData.connections.length > 0) {
                    const floorHeader = document.createElement('h5');
                    floorHeader.textContent = `${floorData.name || floorId} Connections`;
                    floorHeader.style.cssText = 'color: #667eea; margin: 15px 0 10px 0; font-size: 16px;';
                    connectionsList.appendChild(floorHeader);
                    
                    floorData.connections.forEach((connection, index) => {
                        if (connection.length >= 2) {
                            const room1 = floorData.rooms[connection[0]];
                            const room2 = floorData.rooms[connection[1]];
                            const distance = connection[2] || 'Auto-calculated';
                            
                            const connectionItem = document.createElement('div');
                            connectionItem.className = 'connection-item';
                            connectionItem.innerHTML = `
                                <div style="flex: 1;">
                                    <div style="font-weight: 600;">
                                        ${room1?.name || connection[0]} ↔ ${room2?.name || connection[1]}
                                    </div>
                                    <div style="font-size: 12px; color: #666;">
                                        Floor: ${floorData.name} | Distance: ${distance}m
                                    </div>
                                </div>
                                <div style="display: flex; gap: 5px;">
                                    <button onclick="editConnection('${floorId}', ${index})" class="btn btn-primary">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteConnection('${floorId}', ${index})" class="btn btn-danger">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            `;
                            connectionsList.appendChild(connectionItem);
                        }
                    });
                } else {
                    const noConnections = document.createElement('div');
                    noConnections.innerHTML = `<em>No connections on ${floorData.name || floorId}</em>`;
                    noConnections.style.color = '#666';
                    connectionsList.appendChild(noConnections);
                }
            });
        }

        function loadVerticalConnections() {
            const stairsList = document.getElementById('stairsList');
            const elevatorsList = document.getElementById('elevatorsList');
            
            if (!buildingConfig || !buildingConfig.vertical_connections) {
                stairsList.innerHTML = '<div>No building configuration loaded</div>';
                elevatorsList.innerHTML = '<div>No building configuration loaded</div>';
                return;
            }
            
            // Load stairs
            stairsList.innerHTML = '';
            const stairs = buildingConfig.vertical_connections.stairs || [];
            if (stairs.length > 0) {
                stairs.forEach((stair, index) => {
                    const stairItem = document.createElement('div');
                    stairItem.className = 'connection-item';
                    stairItem.innerHTML = `
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">
                                <i class="fas fa-stairs"></i> ${stair.name || `Stairs ${stair.id}`}
                            </div>
                            <div style="font-size: 12px; color: #666;">
                                Floors: ${stair.floors.join(', ')} | Location: (${stair.location.join(', ')})
                            </div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="editStairs(${index})" class="btn btn-primary">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteStairs(${index})" class="btn btn-danger">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    stairsList.appendChild(stairItem);
                });
            } else {
                stairsList.innerHTML = '<div style="color: #666; font-style: italic;">No stairs configured</div>';
            }
            
            // Load elevators
            elevatorsList.innerHTML = '';
            const elevators = buildingConfig.vertical_connections.elevators || [];
            if (elevators.length > 0) {
                elevators.forEach((elevator, index) => {
                    const elevatorItem = document.createElement('div');
                    elevatorItem.className = 'connection-item';
                    elevatorItem.innerHTML = `
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">
                                <i class="fas fa-elevator"></i> ${elevator.name || `Elevator ${elevator.id}`}
                            </div>
                            <div style="font-size: 12px; color: #666;">
                                Floors: ${elevator.floors.join(', ')} | Location: (${elevator.location.join(', ')})
                            </div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="editElevator(${index})" class="btn btn-primary">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteElevator(${index})" class="btn btn-danger">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    elevatorsList.appendChild(elevatorItem);
                });
            } else {
                elevatorsList.innerHTML = '<div style="color: #666; font-style: italic;">No elevators configured</div>';
            }
        }

        function drawFloorPlan() {
            const floorId = document.getElementById('visualFloorSelect').value;
            if (!floorId || !buildingConfig || !buildingConfig.floors[floorId]) {
                return;
            }
            
            const canvas = document.getElementById('floorPlanCanvas');
            const ctx = canvas.getContext('2d');
            const floor = buildingConfig.floors[floorId];
            
            // Set canvas size
            canvas.width = 600;
            canvas.height = 400;
            
            // Clear canvas
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw border
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 2;
            ctx.strokeRect(0, 0, canvas.width, canvas.height);
            
            const floorPlan = floor.floor_plan || { width: 100, height: 100 };
            const scaleX = canvas.width / floorPlan.width;
            const scaleY = canvas.height / floorPlan.height;
            
            // Draw connections first (behind rooms)
            if (floor.connections) {
                ctx.strokeStyle = '#6c757d';
                ctx.lineWidth = 2;
                ctx.globalAlpha = 0.7;
                
                floor.connections.forEach(connection => {
                    if (connection.length >= 2) {
                        const room1 = floor.rooms[connection[0]];
                        const room2 = floor.rooms[connection[1]];
                        
                        if (room1 && room2) {
                            const x1 = room1.coordinates[0] * scaleX;
                            const y1 = room1.coordinates[1] * scaleY;
                            const x2 = room2.coordinates[0] * scaleX;
                            const y2 = room2.coordinates[1] * scaleY;
                            
                            ctx.beginPath();
                            ctx.moveTo(x1, y1);
                            ctx.lineTo(x2, y2);
                            ctx.stroke();
                        }
                    }
                });
                
                ctx.globalAlpha = 1;
            }
            
            // Draw rooms
            const roomTypes = buildingConfig.room_types || {};
            Object.entries(floor.rooms || {}).forEach(([roomId, roomData]) => {
                const x = roomData.coordinates[0] * scaleX;
                const y = roomData.coordinates[1] * scaleY;
                const roomType = roomData.type || 'common';
                const typeInfo = roomTypes[roomType] || { color: '#667eea' };
                
                // Draw room circle
                ctx.fillStyle = typeInfo.color || '#667eea';
                ctx.beginPath();
                ctx.arc(x, y, 8, 0, 2 * Math.PI);
                ctx.fill();
                
                // Draw room border
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 1;
                ctx.stroke();
                
                // Draw room name
                ctx.fillStyle = '#333';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(roomData.name || roomId, x, y - 12);
            });
            
            // Draw vertical connections (stairs, elevators)
            if (buildingConfig.vertical_connections) {
                // Draw stairs
                buildingConfig.vertical_connections.stairs?.forEach(stair => {
                    if (stair.floors.includes(floorId)) {
                        const x = stair.location[0] * scaleX;
                        const y = stair.location[1] * scaleY;
                        
                        ctx.fillStyle = '#dc3545';
                        ctx.fillRect(x - 6, y - 6, 12, 12);
                        
                        ctx.strokeStyle = '#333';
                        ctx.lineWidth = 1;
                        ctx.strokeRect(x - 6, y - 6, 12, 12);
                        
                        ctx.fillStyle = '#333';
                        ctx.font = '8px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText('S', x, y + 2);
                    }
                });
                
                // Draw elevators
                buildingConfig.vertical_connections.elevators?.forEach(elevator => {
                    if (elevator.floors.includes(floorId)) {
                        const x = elevator.location[0] * scaleX;
                        const y = elevator.location[1] * scaleY;
                        
                        ctx.fillStyle = '#ffc107';
                        ctx.fillRect(x - 6, y - 6, 12, 12);
                        
                        ctx.strokeStyle = '#333';
                        ctx.lineWidth = 1;
                        ctx.strokeRect(x - 6, y - 6, 12, 12);
                        
                        ctx.fillStyle = '#333';
                        ctx.font = '8px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText('E', x, y + 2);
                    }
                });
            }
        }

        function showAlert(message, type) {
            const alertsDiv = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                ${message}
                <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; font-size: 16px;">&times;</button>
            `;
            alertsDiv.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function loadRoomOptions() {
            const floorId = document.getElementById('connectionFloor').value;
            const room1Select = document.getElementById('connectionRoom1');
            const room2Select = document.getElementById('connectionRoom2');
            
            room1Select.innerHTML = '<option value="">Select room...</option>';
            room2Select.innerHTML = '<option value="">Select room...</option>';
            
            if (!floorId || !buildingConfig.floors[floorId] || !buildingConfig.floors[floorId].rooms) {
                return;
            }
            
            const rooms = buildingConfig.floors[floorId].rooms;
            Object.entries(rooms).forEach(([roomId, roomData]) => {
                const option1 = document.createElement('option');
                option1.value = roomId;
                option1.textContent = roomData.name || roomId;
                
                const option2 = document.createElement('option');
                option2.value = roomId;
                option2.textContent = roomData.name || roomId;
                
                room1Select.appendChild(option1);
                room2Select.appendChild(option2);
            });
        }
        
        async function saveConnection(event) {
            event.preventDefault();
            
            const floorId = document.getElementById('connectionFloor').value;
            const room1Id = document.getElementById('connectionRoom1').value;
            const room2Id = document.getElementById('connectionRoom2').value;
            const distance = parseFloat(document.getElementById('connectionDistance').value) || null;
            
            if (!buildingConfig.floors[floorId].connections) {
                buildingConfig.floors[floorId].connections = [];
            }
            
            const connection = distance ? [room1Id, room2Id, distance] : [room1Id, room2Id];
            buildingConfig.floors[floorId].connections.push(connection);
            
            closeModal('connectionModal');
            loadConnections();
            showAlert('Connection added successfully', 'success');
        }
        
        function deleteConnection(floorId, connectionIndex) {
            if (confirm('Are you sure you want to delete this connection?')) {
                buildingConfig.floors[floorId].connections.splice(connectionIndex, 1);
                loadConnections();
                showAlert('Connection deleted successfully', 'success');
            }
        }
        
        function editRoom(floorId, roomId) {
            const room = buildingConfig.floors[floorId].rooms[roomId];
            
            document.getElementById('roomModalTitle').textContent = 'Edit Room';
            document.getElementById('roomId').value = roomId;
            document.getElementById('roomName').value = room.name || '';
            document.getElementById('roomType').value = room.type || 'common';
            document.getElementById('roomX').value = room.coordinates ? room.coordinates[0] : 0;
            document.getElementById('roomY').value = room.coordinates ? room.coordinates[1] : 0;
            document.getElementById('roomDescription').value = room.description || '';
            
            document.getElementById('roomId').disabled = true; // Don't allow changing room ID when editing
            
            showModal('roomModal');
        }
        
        function deleteRoom(floorId, roomId) {
            if (confirm(`Are you sure you want to delete room '${roomId}'? This will also remove any connections involving this room.`)) {
                // Remove room
                delete buildingConfig.floors[floorId].rooms[roomId];
                
                // Remove connections involving this room
                if (buildingConfig.floors[floorId].connections) {
                    buildingConfig.floors[floorId].connections = buildingConfig.floors[floorId].connections.filter(
                        conn => conn.length < 2 || (conn[0] !== roomId && conn[1] !== roomId)
                    );
                }
                
                // Remove from entrances if present
                if (buildingConfig.floors[floorId].entrances) {
                    buildingConfig.floors[floorId].entrances = buildingConfig.floors[floorId].entrances.filter(
                        entrance => entrance !== roomId
                    );
                }
                
                loadFloorRooms();
                showAlert('Room deleted successfully', 'success');
            }
        }
        
        function showAddStairsModal() {
            // You would implement a stairs modal similar to the room modal
            const stairsId = prompt('Enter stairs ID:');
            const floorsStr = prompt('Enter floors (comma-separated):');
            const locationStr = prompt('Enter location (x,y):');
            
            if (stairsId && floorsStr && locationStr) {
                const floors = floorsStr.split(',').map(f => f.trim());
                const location = locationStr.split(',').map(l => parseFloat(l.trim()));
                
                if (!buildingConfig.vertical_connections) {
                    buildingConfig.vertical_connections = { stairs: [], elevators: [] };
                }
                
                buildingConfig.vertical_connections.stairs.push({
                    id: stairsId,
                    name: `Stairs ${stairsId}`,
                    floors: floors,
                    location: location
                });
                
                loadVerticalConnections();
                showAlert('Stairs added successfully', 'success');
            }
        }
        
        function showAddElevatorModal() {
            // You would implement an elevator modal similar to the stairs
            const elevatorId = prompt('Enter elevator ID:');
            const floorsStr = prompt('Enter floors (comma-separated):');
            const locationStr = prompt('Enter location (x,y):');
            
            if (elevatorId && floorsStr && locationStr) {
                const floors = floorsStr.split(',').map(f => f.trim());
                const location = locationStr.split(',').map(l => parseFloat(l.trim()));
                
                if (!buildingConfig.vertical_connections) {
                    buildingConfig.vertical_connections = { stairs: [], elevators: [] };
                }
                
                buildingConfig.vertical_connections.elevators.push({
                    id: elevatorId,
                    name: `Elevator ${elevatorId}`,
                    floors: floors,
                    location: location
                });
                
                loadVerticalConnections();
                showAlert('Elevator added successfully', 'success');
            }
        }
        
        function deleteStairs(index) {
            if (confirm('Are you sure you want to delete these stairs?')) {
                buildingConfig.vertical_connections.stairs.splice(index, 1);
                loadVerticalConnections();
                showAlert('Stairs deleted successfully', 'success');
            }
        }
        
        function deleteElevator(index) {
            if (confirm('Are you sure you want to delete this elevator?')) {
                buildingConfig.vertical_connections.elevators.splice(index, 1);
                loadVerticalConnections();
                showAlert('Elevator deleted successfully', 'success');
            }
        }
        
        async function logout() {
            try {
                await fetch('/admin/logout', { method: 'POST' });
                window.location.href = '/admin';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = '/admin';
            }
        }
    </script>
</body>
</html>
